<html>
<script src="jquery.js"></script>
<script src="json.org"></script>

<script type="text/javascript">

$(function(){

    $('#destination_uris').hide();
    $('#cancel').hide();

    $('#cancel').click(function(){
        $.ajax({
            url: "/MCASlite/transco/cancel?id=" + $('#req_id').val(),
            type: "POST"
        });
    });
    
    $('#process').click(function(){
        var mydata = {config: "default", usr: "default", dst: $('#dst_file').val(), src: $('#src_file').val()};
        $.ajax({
            url: "/MCASlite/transco",
            type: "POST",
            contentType: "application/json; charset=UTF-8",
            data: JSON.stringify(mydata),
            success: function(data) {
                $('#req_id').val(data);
                $('#req_status').val('CREATED');
                $('#t_status p').html('CREATED');
                $('#cancel').fadeIn('slow');
                $('#process').prop('disabled', true);
                $('#src_file').prop('disabled', true); 
                $('#dst_file').prop('disabled', true);
            }, statusCode: {
                400 : function(){
                    alert('Bad request, check your source and destination parameters!');
                },
                503 : function(){  
                    alert('System overloaded');
                }
            }, error : function() {
                $('#t_status p').html('Something went wrong, unknown problem!');
            }
        });
    });

    setInterval(function() {
        if ($('#req_id').val() && (
            $('#req_status').val() != 'DONE' &&
            $('#req_status').val() != 'ERROR' &&
            $('#req_status').val() != 'PARTIAL_ERROR' &&
            $('#req_status').val() != 'CANCELLED')) {
            $.ajax({
                type: 'GET',
                url: '/MCASlite/transco?id=' + $('#req_id').val(),
                success: function(data) {
                    $('#t_status p').html(data).children();
                    $('#req_status').val(data);
                    if(data == 'DONE') {
                        $('#process').prop('disabled',false);
                        $('#video_file').val(' ');
                        $('#src_file').prop('disabled', false);
                        $('#dst_file').prop('disabled', false);
                        $.ajax({
                            type: 'GET',
                            url: '/MCASlite/transco/uris?id=' + $('#req_id').val(),
                            dataType: "json",
                            success: function(data) {
                                $.each(data.destinationUris, function(i,item) {
                                    $('#destination_uris').append(data.destinationUris[i].uri + "\n");
                                });
                                $('#destination_uris').slideDown('slow');
                            }            
                        });
                    }
                }
            });
        }
    }, 10000);
});

</script>

<body>
    <div>
        <form method="POST" enctype="multipart/form-data" id="transcoder">
            Source file: <input type="text" value="" id="src_file" size="100"></br>
            Destination folder: <input type="text" value="" id="dst_file" size="100"></br>
            <input type="button" value="Start transco" id="process">
            <input type="hidden" value="" id="req_id">
            <input type="hidden" value="" id="req_status">
            <input type="button" value="Cancel" id="cancel">
        </form>
        <div id='t_status'>
            <p></p>
            <textarea id="destination_uris" cols="100" rows="3" readonly="true"></textarea>
        </div>
    </div>
</body>
</html>

